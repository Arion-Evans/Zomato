---
title: "Predicting Zomato restaurant ratings with logistic regression"
author: "Arion Barzoucas-Evans (s3650046) & Joshua Grosman (s3494389)"
date: "02/09/2018"
output:
  pdf_document:
    latex_engine: xelatex
    number_sections: yes
    fig_caption: yes
  word_document:
    toc: no
    toc_depth: '3'
  html_document:
    df_print: paged
    toc: no
    toc_depth: '3'
header-includes: \usepackage{float}
linkcolor: blue
documentclass: article
subtitle: MATH 1298 Analysis of Categorical Data Project Phase I
bibliography: references.bib
---


\newpage

\tableofcontents

\newpage

```{r, include=FALSE, message=FALSE, warning=FALSE}
# CAPTIONS
library(captioner)
fig_nums <- captioner(prefix = "Figure")

fig_nums(name = "rating.pie", caption = "Distribution of the different restaurant ratings in the dataset.")
fig_nums(name = "cost.density", caption = "Distribution of the standardised average cost by currency for two people.")
fig_nums(name = "cost-rating", caption = "Distribution of the standardised average cost by currency for two people by rating.")
fig_nums(name = "booking", caption = "Number of restaurants offering table booking to customers.")
fig_nums(name = "booking-rating", caption = "Proportion of different restaurant ratings by table booking availability.")
fig_nums(name = "delivery", caption = "Number of restaurants offering online delivery to customers.")

fig_nums(name = "delivery-rating", caption = "Proportion of different restaurant ratings by online delivery availability.")

fig_nums(name = "logvotes", caption = "Distribution of the log transformed number of votes for each restaurant in the dataset.")

fig_nums(name = "logvotes-rating", caption = "Distribution of the log transformed number of votes for each restaurant by rating.")
fig_nums(name = "map", caption = "Restaurant locations")

fig_nums(name = "continent-rating", caption = "Proportion of different restaurant ratings by continent.")
fig_nums(name = "cuisine", caption = "Different cuisines and the number of restaurants that offer them.")
fig_nums(name = "cuisine-rating", caption = "Rating distribution by cuisine.")


fig_nums(name = "cost-votes-continent", caption = "Relationship between cost and the log transformed number of votes accross continents and ratings.")
fig_nums(name = "votes-booking-continent", caption = "Distribution of the log transformed votes accross continent, rating, and whether or not the restaurant offers table booking.")
fig_nums(name = "cost-continent-rating", caption = "Distribution of the standardised average cost by currency for two people by rating and continent.")

```

# Introduction \label{sec1}


Zomato is a restaurant search and discovery service founded in 2008. Users can access a plethora of information about restaurants listed on Zomato, including information not available on the restaurant's own website. Such information includes the type of cuisine, opening hours, photos of the menu and the restaurant, pricing, and whether the restaurant offers online delivery. Customers that visit the restaurants have the option of reviewing them and giving them a rating from 0 to 5. Higher rated restaurants receive more attention resulting in higher revenues. As such, understanding how users of Zomato rate restaurants is of great interest to restaurant owners in order to improve their business. The aim of this report is to explore the relationship of several factors like price and cuisine with Zomato ratings using publicly available data found on [Kaggle](https://www.kaggle.com/shrutimehta/zomato-restaurants-data). In phase I exploratory data analysis will be performed on the dataset, including data pre-processing, creation of new variables, and visual representation of the data. This will assist in observing and understanding any relationships present in the data. Following this, a logistic regression model will be fitted in phase II in order to predict the probability of receiving certain ratings according to the values of the chosen explanatory variables.

# Data Set

The dataset used in this report was acquired from [Kaggle](https://www.kaggle.com/shrutimehta/zomato-restaurants-data). It contains 9,551 observations each of which corresponds to a different restaurant and contains the following information:

* *Restaurant.ID*: A unique ID assigned to each restaurant.
* *Restaurant.Name*: Name of the restaurant.
* *Country.Code*: Codes corresponding to countries listed in a separate dataset.
* *City*: Name of the city where the restaurant is located.
* *Address*: Address of the restaurant.
* *Locality*: General location of the restaurant (short description).
* *Locality.Verbose*: General location of the restaurant (long description).
* *Longitude*: Longitude of the location of the restaurant (geographic coordinates).
* *Latitude*: Latitude of the location of the restaurant (geographic coordinates).
* *Cuisines*: Type of cuisine offered by the restaurant.
* *Average.Cost.for.two*: Average cost for two people (in the countries respective currency).
* *Currency*: Currency which is used at each restaurant.
* *Has.Table.booking*: Whether the restaurant offers the option to book a table or not.
* *Has.Online.delivery*: Whether the restaurant offers delivery through the internet or not.
* *Is.delivering.now*: Whether the restaurant was delivering at the time the dataset was created or not.
* *Switch.to.order.menu*: Unclear variable with only one level (No) for all observations.
* *Price.range*: Categorised price (between 1 and 4).
* *Aggregate.rating*: Aggregated rating from user votes.
* *Rating.color*: Categorised rating into a colour code.
* *Rating.text*: Response variable. Categorised rating with 6 levels (from Poor to Excellent).
* *Votes*: Number of votes used in the aggregate rating.



\newpage

# Data Preparation


In this project, the following `R` packages were used.

```{r, message = FALSE, warning=FALSE}
library(mlr)
library(data.table)
library(plyr)
library(dplyr)
library(ggplot2)
library(vcd)
library(knitr)
library(kableExtra)

```

```{r, message = FALSE, warning=FALSE, include=FALSE}
# custom str function
str_format <- function(df){
  df_sum = data.frame(Variable = names(df),
                  Class = sapply(df, class),
                  Cardinality = sapply(df, function(x){
                    if(class(x) == "factor"){
                      return(length(levels(x)))
                    }
                    return(length(unique(x)))
                  }),
                  Levels = sapply(df, function(x){
                    if(class(x) == "factor"){
                      return(paste0(head(levels(x), n = 3), collapse = ", "))
                    }
                    return(paste0(head(unique(x), n = 3), collapse = ", "))
                  }),
                  First_Values = sapply(df, function(x) paste0(head(x),  collapse = ", ")),
                  row.names = NULL) 
  
  colnames(df_sum)[5] = "First Values"
  colnames(df_sum)[4] = "First Levels"
  
  return(df_sum)
}


# ggplot theme
ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank(),
  panel.background = element_blank()
)
```


```{r, message = FALSE, warning=FALSE, echo=FALSE, include=FALSE}
zomato = read.csv("zomato.csv")
zomato = as.data.table(zomato)

countries = read.csv("Country-Code.csv")

```

As Table 1 indicates, there are no NA values in any of the features. Additionally, according to Table 2 restaurant ID's are unique for every restaurant while it seems there are some duplicate restaurant names due to the existence of restaurant chains. Furthermore, each restaurant has multiple cuisines which causes the `cuisine` feature to have a large amount of levels. Finally, the `Switch.to.order.menu` feature only has one level ("No") for the entire dataset.


```{r, message = FALSE, warning=FALSE, echo=FALSE}
kable(as.data.frame(summarizeColumns(zomato)),
      caption = "Feature summary before data preprocessing.",
      format = "latex") %>% kable_styling(latex_options = c("scale_down","HOLD_position"))

```

```{r, message = FALSE, warning=FALSE, echo=FALSE}
zomato_temp = zomato
zomato_temp[,c(2,5:7,10)] = lapply(zomato[,c(2,5:7,10)], strtrim, width = 10)

df = str_format(zomato_temp)

kable(df, caption = "Variable summary for the Zomato dataset\n9551 Observations of 21 Variables",
        format = "latex") %>% kable_styling(latex_options = c("scale_down","HOLD_position"))
```

To rectify the identified issues, all unnecessary features were removed. This includes `Restaurant.ID` (unique identifier), `Restaurant.Name`, `Address`, `Locality`, `Locality.Verbose`, `Is.delivering.now`, `Switch.to.order.menu`, `City`, `Currency`, `Rating.color`. The `Average.Cost.for.two` is in many different currencies and the concept of what is considered expensive would be affected by socio-economic factors in each country. For this reason, this feature was standardised by currency. Furthermore, the `cuisines` variable was separated into 18 new binary features using the most prevalent levels within the original `cuisines` variable. Each of these features indicate the presence or absence of that particular cuisine in the restaurant. This way, restaurants can have multiple cuisines. Using these new binary variables, a new feature, `Cuisine_Range`, was created as the sum of all the cuisine binary variables. The `Cuisine_Range` would indicate the number of different cuisines present in a restaurant which may be of interest to the model in deciding a restaurant's rating. `Has.Table.booking` and `Has.Online.delivery` were recoded into binary variables, the country table was joined to the Zomato dataset through `Country.Code` and then aggregated into a `Continent` feature. Finally, the levels of the response variable, `Rating.text`, originally included the level "Not rated". As it is not reasonable to predict this level, all associated instances were removed from the data. Tables 3 and 4 show the data after all pre-processing.

```{r, message = FALSE, warning=FALSE, echo=FALSE}
# Scale cost by currency
zomato[,Average.Cost.for.two.Std := as.vector(scale(Average.Cost.for.two)), by=Currency]

# Reorder columns and remove original cost column
zomato = zomato[,c(1:11,22,12:21)]
zomato = zomato[,Average.Cost.for.two := NULL]

# Create new binary variables for cuisine type (1-C encoding)
splitdat = do.call("rbind", strsplit(as.character(zomato$Cuisines), ","))
unique.cuisines = as.vector(unique(as.vector(trimws(splitdat))))
current.names = as.vector(names(zomato))

new.names = as.vector(matrix(c(current.names,unique.cuisines))) 

for(i in 1:length(unique.cuisines)){
  zomato[,paste(i)] = rep(0,nrow(zomato))
}

names(zomato) = new.names

for(i in 1:length(unique.cuisines)){
zomato[,unique.cuisines[i]] = ifelse(grepl(unique.cuisines[i],zomato$Cuisines),1,0)
}


# Aggregate new variables 
zomato = zomato[, `:=`(European = French+European+Italian+German+
                                  Mediterranean+Greek+Spanish+Irish+
                                  British+Portuguese+Scottish+Belgian,
                       Asian = Japanese+Chinese+Asian+Filipino+Korean+
                               Vietnamese+Thai+Singaporean+Malaysian+
                               Indonesian+Taiwanese+Cantonese+Malay+
                               Peranakan+Sunda,
                       `South American` = Brazilian+Mexican+Peruvian+
                                          `Latin American`+Caribbean+
                                          Cuban+`South American`+Argentine+
                                          Mineira,
                       Indian = Indian+Goan+`South Indian`+`North Indian`+
                                Rajasthani+Mughlai+Mithai+Maharashtrian+
                                `Modern Indian`+Biryani+Parsi+Kashmiri+
                                Bengali+Awadhi+Lucknowi+Gujarati+Oriya+
                                Hyderabadi+Bihari+Kerala+Andhra+Malwani+
                                Assamese+Naga+Chettinad+Mangalorean,
                       American = American+Hawaiian+`New American`+Cajun+Canadian,
                       `Middle Eastern` = `Middle Eastern`+Arabian+Lebanese+
                                          Turkish+Pakistani+Persian+Burmese+Tibetan+
                                          Afghani+Nepalese+Iranian+Izgara+Armenian+Durban,
                       Other = `Bar Food`+International+Steak+BBQ+Southern+Breakfast+
                               Sandwich+`Modern Australian`+African+`North Eastern`+`Tex-Mex`+
                               `Cuisine Varies`+`Charcoal Grill`+`Asian Fusion`+Kiwi+Contemporary+
                               Ramen+Grill+`Sri Lankan`+Kebab+`World Cuisine`+`Turkish Pizza`+
                               `Restaurant Cafe`+Southwestern+Diner+Teriyaki+Vegetarian+
                               Fusion+Deli+`Fish and Chips`+`Dim Sum`+Curry+`South African`+
                               Bí_rek+`Soul Food`+Moroccan+Dí_ner+`Pub Food`+Tapas+Western+
                               Australian+Sushi+Salad,
                       Desserts = Desserts+`Ice Cream`+Patisserie,
                       `Fast Food` = `Fast Food`+`Gourmet Fast Food`,
                       Beverages = Beverages+Juices+`Coffee and Tea`+Tea+`Drinks Only`+`Bubble Tea`)]

zomato = zomato[, `:=`(French=NULL,Italian=NULL,German=NULL,
                    Mediterranean=NULL,Greek=NULL,Spanish=NULL,Irish=NULL,
                    British=NULL,Portuguese=NULL,Scottish=NULL,Belgian=NULL,
                    Japanese=NULL,Chinese=NULL,Filipino=NULL,Korean=NULL,
                    Vietnamese=NULL,Thai=NULL,Singaporean=NULL,Malaysian=NULL,
                    Indonesian=NULL,Taiwanese=NULL,Cantonese=NULL,Malay=NULL,
                    Peranakan=NULL,Sunda=NULL,
                    Brazilian=NULL,Mexican=NULL,Peruvian=NULL,
                    `Latin American`=NULL,Caribbean=NULL,
                    Cuban=NULL,Argentine=NULL,Mineira=NULL,
                    Goan=NULL,`South Indian`=NULL,`North Indian`=NULL,
                    Rajasthani=NULL,Mughlai=NULL,Mithai=NULL,Maharashtrian=NULL,
                    `Modern Indian`=NULL,Biryani=NULL,Parsi=NULL,Kashmiri=NULL,
                    Bengali=NULL,Awadhi=NULL,Lucknowi=NULL,Gujarati=NULL,Oriya=NULL,
                    Hyderabadi=NULL,Bihari=NULL,Kerala=NULL,Andhra=NULL,Malwani=NULL,
                    Assamese=NULL,Naga=NULL,Chettinad=NULL,Mangalorean=NULL,
                    American=NULL,Hawaiian=NULL,`New American`=NULL,Cajun=NULL,Canadian=NULL,
                    `Middle Eastern`=NULL,Arabian=NULL,Lebanese=NULL,
                    Turkish=NULL,Pakistani=NULL,Persian=NULL,Burmese=NULL,Tibetan=NULL,
                    Afghani=NULL,Nepalese=NULL,Iranian=NULL,Izgara=NULL,Armenian=NULL,Durban=NULL,
                    `Bar Food`=NULL,International=NULL,Steak=NULL,BBQ=NULL,Southern=NULL,Breakfast=NULL,
                    Sandwich=NULL,`Modern Australian`=NULL,African=NULL,`North Eastern`=NULL,`Tex-Mex`=NULL,
                    `Cuisine Varies`=NULL,`Charcoal Grill`=NULL,`Asian Fusion`=NULL,Kiwi=NULL,Contemporary=NULL,
                    Ramen=NULL,Grill=NULL,`Sri Lankan`=NULL,Kebab=NULL,`World Cuisine`=NULL,`Turkish Pizza`=NULL,
                    `Restaurant Cafe`=NULL,Southwestern=NULL,Diner=NULL,Teriyaki=NULL,Vegetarian=NULL,
                    Fusion=NULL,Deli=NULL,`Fish and Chips`=NULL,`Dim Sum`=NULL,Curry=NULL,`South African`=NULL,
                    Bí_rek=NULL,`Soul Food`=NULL,Moroccan=NULL,Dí_ner=NULL,`Pub Food`=NULL,Tapas=NULL,
                    Western=NULL,Australian=NULL,Sushi=NULL,`Ice Cream`=NULL,Patisserie=NULL,
                    `Gourmet Fast Food`=NULL,Salad=NULL,Juices=NULL,`Coffee and Tea`=NULL,
                    Tea=NULL,`Drinks Only`=NULL,`Bubble Tea`=NULL)]


# Make variables binary again
for(j in names(zomato)[-c(1:21)]){
  set(zomato, i= which(zomato[[j]]>1), j= j, value= 1)
}   

# Map country code to country
zomato = merge(zomato,countries,by = "Country.Code")
zomato = zomato[,Country.Code := NULL]

# Remove remaining unnecessary variables
zomato = zomato[,c("Restaurant.ID","Restaurant.Name","Address",
                   "Locality","Locality.Verbose","Cuisines",
                   "Is.delivering.now","Switch.to.order.menu",
                   "City","Currency","Rating.color"):=NULL]


#Converting yes/no cols to numeric
zomato$Has.Table.booking <- revalue(zomato$Has.Table.booking, c("No"=0, "Yes"=1))
zomato$Has.Online.delivery <- revalue(zomato$Has.Online.delivery, c("No"=0, "Yes"=1))

#Aggregating country into continent(maybe leave india on its own?)
Europe <- c("United Kingdom")
North_America <- c("United States","Canada")
Asia <- c("India","Indonesia","Singapore","Sri Lanka","UAE","Phillipines","Qatar")
Oceania <- c("Australia", "New Zealand")
ROW <- c("Brazil","South Africa", "Turkey")

zomato$continent = zomato$Country

levels(zomato$continent)[levels(zomato$continent) %in% Europe] = "Europe"
levels(zomato$continent)[levels(zomato$continent) %in% North_America] = "North America"
levels(zomato$continent)[levels(zomato$continent) %in% Asia] = "Asia"
levels(zomato$continent)[levels(zomato$continent) %in% Oceania] = "Oceania"
levels(zomato$continent)[levels(zomato$continent) %in% ROW] = "Rest of World"

zomato$Country<-NULL

#converting continent to binary
setDT(zomato)[, c(levels(zomato$continent), "continent") := 
            c(lapply(levels(continent), function(x) as.integer(x == continent)), .(NULL))]

#creating new variable for range of cuisine

zomato$Cuisine_Range = rowSums(zomato[,10:27])

# aggregate cuisine range
zomato$Cuisine_Range = as.factor(zomato$Cuisine_Range)
levels(zomato$Cuisine_Range)[levels(zomato$Cuisine_Range) %in% c("5","6","7","8")] = ">4"


#removing not rated level from rating.text
zomato = zomato[Rating.text != "Not rated"] %>% droplevels()
```



```{r, message = FALSE, warning=FALSE, echo=FALSE}
kable(as.data.frame(summarizeColumns(zomato)),
      caption = "Feature summary after data preprocessing.",
      digits = 3) %>% 
  kable_styling(latex_options = c("scale_down","HOLD_position"))

```

```{r, message = FALSE, warning=FALSE, echo=FALSE}
cols <- names(zomato)[1:3]
df = str_format(zomato[,(cols) := round(.SD,3), .SDcols=cols])

kable(df, caption = "Variable summary for the Zomato dataset after preprocessing\n7403 Observations of 33 Variables",
        format = "latex") %>% kable_styling(latex_options = c("scale_down","HOLD_position"))
```

```{r, message = FALSE, warning=FALSE, echo=FALSE}
# get column tables after cleaning
col.freq = list()
for (i in (1:ncol(zomato))){
  col.freq[[i]] = table(zomato[,..i], dnn = colnames(zomato)[i])
}

col.freq[c(4:6,8,10:33)] %>% kable(caption = "Contingency tables for discrete and categorical variables.",
                                  format = "latex", booktabs = TRUE) %>% 
  kable_styling(latex_options = "HOLD_position")
```

\newpage

# Data Visualisation

```{r, warning=FALSE, message=FALSE, echo=FALSE}
########## Data prep #####################################
zomato = read.csv("zomato.csv")
zomato = as.data.table(zomato)

countries = read.csv("Country-Code.csv")


# Scale cost by currency
zomato[,Average.Cost.for.two.Std := as.vector(scale(Average.Cost.for.two)), by=Currency]


# Create new binary variables for cuisine type (1-C encoding)
splitdat = do.call("rbind", strsplit(as.character(zomato$Cuisines), ","))
unique.cuisines = as.vector(unique(as.vector(trimws(splitdat))))
current.names = as.vector(names(zomato))

new.names = as.vector(matrix(c(current.names,unique.cuisines))) 

for(i in 1:length(unique.cuisines)){
  zomato[,paste(i)] = rep(0,nrow(zomato))
}

names(zomato) = new.names

for(i in 1:length(unique.cuisines)){
  zomato[,unique.cuisines[i]] = ifelse(grepl(unique.cuisines[i],zomato$Cuisines),1,0)
}


# Aggregate new variables 
zomato = zomato[, `:=`(European = French+European+Italian+German+
                         Mediterranean+Greek+Spanish+Irish+
                         British+Portuguese+Scottish+Belgian,
                       Asian = Japanese+Chinese+Asian+Filipino+Korean+
                         Vietnamese+Thai+Singaporean+Malaysian+
                         Indonesian+Taiwanese+Cantonese+Malay+
                         Peranakan+Sunda,
                       `South American` = Brazilian+Mexican+Peruvian+
                         `Latin American`+Caribbean+
                         Cuban+`South American`+Argentine+
                         Mineira,
                       Indian = Indian+Goan+`South Indian`+`North Indian`+
                         Rajasthani+Mughlai+Mithai+Maharashtrian+
                         `Modern Indian`+Biryani+Parsi+Kashmiri+
                         Bengali+Awadhi+Lucknowi+Gujarati+Oriya+
                         Hyderabadi+Bihari+Kerala+Andhra+Malwani+
                         Assamese+Naga+Chettinad+Mangalorean,
                       American = American+Hawaiian+`New American`+Cajun+Canadian,
                       `Middle Eastern` = `Middle Eastern`+Arabian+Lebanese+
                         Turkish+Pakistani+Persian+Burmese+Tibetan+
                         Afghani+Nepalese+Iranian+Izgara+Armenian+Durban,
                       Other = `Bar Food`+International+Steak+BBQ+Southern+Breakfast+
                         Sandwich+`Modern Australian`+African+`North Eastern`+`Tex-Mex`+
                         `Cuisine Varies`+`Charcoal Grill`+`Asian Fusion`+Kiwi+Contemporary+
                         Ramen+Grill+`Sri Lankan`+Kebab+`World Cuisine`+`Turkish Pizza`+
                         `Restaurant Cafe`+Southwestern+Diner+Teriyaki+Vegetarian+
                         Fusion+Deli+`Fish and Chips`+`Dim Sum`+Curry+`South African`+
                         Bí_rek+`Soul Food`+Moroccan+Dí_ner+`Pub Food`+Tapas+Western+
                         Australian+Sushi+Salad,
                       Desserts = Desserts+`Ice Cream`+Patisserie,
                       `Fast Food` = `Fast Food`+`Gourmet Fast Food`,
                       Beverages = Beverages+Juices+`Coffee and Tea`+Tea+`Drinks Only`+`Bubble Tea`)]

zomato = zomato[, `:=`(French=NULL,Italian=NULL,German=NULL,
                       Mediterranean=NULL,Greek=NULL,Spanish=NULL,Irish=NULL,
                       British=NULL,Portuguese=NULL,Scottish=NULL,Belgian=NULL,
                       Japanese=NULL,Chinese=NULL,Filipino=NULL,Korean=NULL,
                       Vietnamese=NULL,Thai=NULL,Singaporean=NULL,Malaysian=NULL,
                       Indonesian=NULL,Taiwanese=NULL,Cantonese=NULL,Malay=NULL,
                       Peranakan=NULL,Sunda=NULL,
                       Brazilian=NULL,Mexican=NULL,Peruvian=NULL,
                       `Latin American`=NULL,Caribbean=NULL,
                       Cuban=NULL,Argentine=NULL,Mineira=NULL,
                       Goan=NULL,`South Indian`=NULL,`North Indian`=NULL,
                       Rajasthani=NULL,Mughlai=NULL,Mithai=NULL,Maharashtrian=NULL,
                       `Modern Indian`=NULL,Biryani=NULL,Parsi=NULL,Kashmiri=NULL,
                       Bengali=NULL,Awadhi=NULL,Lucknowi=NULL,Gujarati=NULL,Oriya=NULL,
                       Hyderabadi=NULL,Bihari=NULL,Kerala=NULL,Andhra=NULL,Malwani=NULL,
                       Assamese=NULL,Naga=NULL,Chettinad=NULL,Mangalorean=NULL,
                       American=NULL,Hawaiian=NULL,`New American`=NULL,Cajun=NULL,Canadian=NULL,
                       `Middle Eastern`=NULL,Arabian=NULL,Lebanese=NULL,
                       Turkish=NULL,Pakistani=NULL,Persian=NULL,Burmese=NULL,Tibetan=NULL,
                       Afghani=NULL,Nepalese=NULL,Iranian=NULL,Izgara=NULL,Armenian=NULL,Durban=NULL,
                       `Bar Food`=NULL,International=NULL,Steak=NULL,BBQ=NULL,Southern=NULL,Breakfast=NULL,
                       Sandwich=NULL,`Modern Australian`=NULL,African=NULL,`North Eastern`=NULL,`Tex-Mex`=NULL,
                       `Cuisine Varies`=NULL,`Charcoal Grill`=NULL,`Asian Fusion`=NULL,Kiwi=NULL,Contemporary=NULL,
                       Ramen=NULL,Grill=NULL,`Sri Lankan`=NULL,Kebab=NULL,`World Cuisine`=NULL,`Turkish Pizza`=NULL,
                       `Restaurant Cafe`=NULL,Southwestern=NULL,Diner=NULL,Teriyaki=NULL,Vegetarian=NULL,
                       Fusion=NULL,Deli=NULL,`Fish and Chips`=NULL,`Dim Sum`=NULL,Curry=NULL,`South African`=NULL,
                       Bí_rek=NULL,`Soul Food`=NULL,Moroccan=NULL,Dí_ner=NULL,`Pub Food`=NULL,Tapas=NULL,
                       Western=NULL,Australian=NULL,Sushi=NULL,`Ice Cream`=NULL,Patisserie=NULL,
                       `Gourmet Fast Food`=NULL,Salad=NULL,Juices=NULL,`Coffee and Tea`=NULL,
                       Tea=NULL,`Drinks Only`=NULL,`Bubble Tea`=NULL)]


# Make variables binary again
for(j in names(zomato)[-c(1:21)]){
  set(zomato, i= which(zomato[[j]]>1), j= j, value= 1)
}   

# Map country code to country
zomato = merge(zomato,countries,by = "Country.Code")
zomato = zomato[,Country.Code := NULL]

# Remove remaining unnecessary variables
zomato = zomato[,c("Restaurant.ID","Restaurant.Name","Address",
                   "Locality","Locality.Verbose","Cuisines",
                   "Is.delivering.now","Switch.to.order.menu",
                   "City","Currency","Rating.color"):=NULL]

################### josh additions ###########################

#Aggregating country into continent(maybe leave india on its own?)
Europe <- c("United Kingdom")
North_America <- c("United States","Canada")
Asia <- c("India","Indonesia","Singapore","Sri Lanka","UAE","Phillipines","Qatar")
Oceania <- c("Australia", "New Zealand")
ROW <- c("Brazil","South Africa", "Turkey")

zomato$continent <- case_when(
  zomato$Country %in% Europe ~ "Europe",
  zomato$Country %in% North_America ~ "North America",
  zomato$Country %in% Asia ~ "Asia",
  zomato$Country %in% Oceania ~ "Oceania",
  zomato$Country %in% ROW ~ "Rest of World"
)

zomato$continent<-as.factor(zomato$continent)


#returning cuisine to a single column of factors (for visualisation)
set.seed(123)
zomato$cuisine<-max.col(zomato[,11:28])
zomato$cuisine<-zomato$cuisine%>%factor()

zomato$cuisine<-revalue(zomato$cuisine, c("1"=names(zomato[,11]),
                                          "2"=names(zomato[,12]),
                                          "3"=names(zomato[,13]),
                                          "4"=names(zomato[,14]),
                                          "5"=names(zomato[,15]),
                                          "6"=names(zomato[,16]),
                                          "7"=names(zomato[,17]),
                                          "8"=names(zomato[,18]),
                                          "9"=names(zomato[,19]),
                                          "10"=names(zomato[,20]),
                                          "11"=names(zomato[,21]),
                                          "12"=names(zomato[,22]),
                                          "13"=names(zomato[,23]),
                                          "14"=names(zomato[,24]),
                                          "15"=names(zomato[,25]),
                                          "16"=names(zomato[,26]),
                                          "17"=names(zomato[,27]),
                                          "18"=names(zomato[,28])))

#creating new variable for range of cuisine

zomato$Cuisine_Range = rowSums(zomato[,11:28])

# aggregate cuisine range
zomato$Cuisine_Range = as.factor(zomato$Cuisine_Range)
levels(zomato$Cuisine_Range)[levels(zomato$Cuisine_Range) %in% c("5","6","7","8")] = ">4"


#removing binary columns
zomato = zomato[,c("Seafood","Asian","European",
                   "Cafe","Fast Food","Bakery","Pizza","Desserts","Other",
                   "Beverages","Burger","Indian","Finger Food","Healthy Food",
                   "Continental","Street Food","Raw Meats","South American"):=NULL]

```


## Univariate and Bivariate

Initially, the proportions of the different levels of the rating response variable were examined.

```{r, warning=FALSE, message=FALSE, echo=FALSE}
#filter
zomato<-zomato%>%filter(Rating.text != "Not rated")%>%droplevels()
zomato$Rating.text <- ordered(zomato$Rating.text, levels = c("Poor", "Average", "Good","Very Good","Excellent"))

c_palette<-c("#ffd92f", "#fc8d62", "#8da0cb", "#e78ac3", "#a6d854")

prop = table(zomato$Rating.text) %>% prop.table() %>% as.data.frame()
prop$Freq = prop$Freq*100

ggplot(data = prop, aes(x = Var1, y = Freq)) +
  geom_bar(stat="identity", fill = c_palette[4]) +
  labs(title = "Restaurant rating distribution",
       y = "Count", x = "Rating") +
  theme_minimal()

```
`r fig_nums("rating.pie")`

\hfill\break

Here it can be seen that the majority of restaurant ratings in the dataset were average. Only a small portion received a rating of either poor or excellent.

Next, the average cost of meal was considered both on its own and with respect to ratings. The associated visualisations are shown in `r fig_nums("cost.density", display = "cite")` and `r fig_nums("cost-rating", display = "cite")`, respectively.

```{r, warning=FALSE, message=FALSE, echo=FALSE}
ggplot(zomato, aes(x=Average.Cost.for.two.Std)) +
  geom_histogram(aes(y=..density..)) + 
  geom_density(aes(y=..density..),fill=c_palette[4],alpha=.5)+
  theme_minimal()+labs(title="Distribution of Standardised Average Cost",
                       x="Standardised Avergage Cost",
                       y="Density")
```
`r fig_nums("cost.density")`

\hfill\break

```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.width=7, fig.height=6}
ggplot(zomato, aes(x=Average.Cost.for.two.Std)) +   
  geom_histogram(aes(y=..density..)) + 
  geom_density(aes(y=..density..),fill=c_palette[4],alpha=.5)+
  facet_wrap(~Rating.text)+
  theme_minimal()+labs(title="Distribution of Standardised Average Cost for Two by Rating",
                       x="Standardised Avergage Cost",
                       y="Density")
```
`r fig_nums("cost-rating")`

\hfill\break



`r fig_nums("cost.density", display = "cite")` gives a general idea of the average cost for all restaurants included in the dataset. Evidently, the distribution has normal-like qualities with respect to its bell-shaped curve. There is, however, a clear spike in restaurants which may be considered to have a very expensive average cost. From `r fig_nums("cost-rating", display = "cite")`, it is clear that all rating levels have a similar distribution to `r fig_nums("cost.density", display = "cite")`, however the spike in expensive average meal cost can be seen to become more profound as rating goes up towards excellent. This would suggest that high rated restaurants are more likely to be more expensive on average.

Next, the binary variable describing whether or not a restaurant had the option to book a table was considered on its own and according to restaurant rating.

```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=4}
ggplot(zomato,aes(x=Has.Table.booking))+
  geom_bar(fill=c_palette[4], width = 0.5)+
  theme_minimal()+labs(title="Count of Table Booking Status",
                       x="Table Booking",
                       y="Count")
```
`r fig_nums("booking")`

\hfill\break

```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=4}
table_rate <- table(zomato$Has.Table.booking,zomato$Rating.text, dnn = c("Table Booking","Rating"))
prop.table_rate<-data.frame(prop.table(table_rate,1))
colnames(prop.table_rate) <- c("Table Booking","Rating","Proportion")

p1<-ggplot(prop.table_rate,aes(x=`Table Booking`,y=Proportion,fill=Rating))
p1+geom_bar(stat="identity",position="dodge")+
  labs(title="Proportions of Rating by Table Booking Status") +
  theme_minimal()+
  scale_fill_manual(values=c_palette)
```
`r fig_nums("booking-rating")`





`r fig_nums("booking", display = "cite")` shows that overall, there are much more restaurants which do not offer table booking in the present sample than those that do. `r fig_nums("booking-rating", display = "cite")` bypasses this issue by examining the relative proportions of rating within each level. Here, the option of booking a table can be seen to have some effect on the rating of a restaurant, with restaurants which do offer table booking having higher proportions of good and very good ratings.

Similar visualisations were used to compare the effect of having online delivery with regard to ratings, as shown in `r fig_nums("delivery", display = "cite")` and `r fig_nums("delivery-rating", display = "cite")`.

\hfill\break

```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=2.5}
ggplot(zomato,aes(x=Has.Online.delivery))+
  geom_bar(fill=c_palette[4], width = 0.5)+
  theme_minimal()+labs(title="Count of Online Delivery Status",
                       x="Online Delivery",
                       y="Count")
```
`r fig_nums("delivery")`

\hfill\break

```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=3.5}
del_rate <- table(zomato$Has.Online.delivery,zomato$Rating.text, dnn = c("Online Delivery","Rating"))
prop.del_rate<-data.frame(prop.table(del_rate,1))
colnames(prop.del_rate) <- c("Online Delivery","Rating","Proportion")

p2<-ggplot(prop.del_rate,aes(x=`Online Delivery`,y=Proportion,fill=Rating))
p2+geom_bar(stat="identity",position="dodge")+
  labs(title="Proportions of Rating by Online Delivery Status") +
  theme_minimal()+
  scale_fill_manual(values=c_palette)
```
`r fig_nums("delivery-rating")`



\newpage

From `r fig_nums("delivery", display = "cite")` it can be seen that restaurants which do not offer online delivery are more prevalent in the dataset than those which do offer it. `r fig_nums("delivery-rating", display = "cite")` suggests that having the option of online delivery has little effect on restaurant ratings, with similar proportions in both levels. There are, however, some deviations in the proportions of poor and good rated restaurants.

Next, the amount of customer votes each restaurant received was considered. Due to issues with scale, the log transformation was applied to customer votes.

```{r, warning=FALSE, message=FALSE, echo=FALSE}
ggplot(data = zomato, aes(x = log(Votes+1))) +
  geom_histogram(aes(y=..density..)) + 
  geom_density(aes(y=..density..),fill=c_palette[4],alpha=.5)+
  labs(x = "Log of Votes",
       title = "Distribution of Log of Customer Votes")
```
`r fig_nums("logvotes")`

\hfill\break

```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=7}
ggplot(zomato, aes(x=log(Votes+1))) +   
  geom_histogram(aes(y=..density..)) + 
  geom_density(aes(y=..density..),fill=c_palette[4],alpha=.4)+
  facet_wrap(~Rating.text)+
  theme_minimal()+labs(title="Distributions of Log of Customer Votes by Rating",
                       x="Log of Votes",
                       y="Density")
```
`r fig_nums("logvotes-rating")`

\hfill\break



`r fig_nums("logvotes", display = "cite")` demonstrates a clear right skew, suggesting that only a few restaurants received a large amount of votes. A trend can be observed within `r fig_nums("logvotes-rating", display = "cite")`, wherein higher ratings appear to be associated with more votes. This trend is disrupted however for restaurants which receive an average rating, which seem to have fewer votes than poor-rated restaurants on average. This may be due to customers being more likely to convey an underwhelming experience at a poor-rated restaurant than a mediocre experience at an average-rated restaurant.

\newpage

The continent the restaurant was located in was then considered. `r fig_nums("map", display = "cite")` below depicts a world map of the location of all restaurants within the dataset. `r fig_nums("continent-rating", display = "cite")` then considers the proportional distribution of ratings across the continents.

```{r, warning=FALSE, message=FALSE, echo=FALSE}
WorldData <- map_data('world')
WorldData <- WorldData %>% filter(region != "Antarctica")


p <- ggplot()
p <- p + geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="antiquewhite", colour="#7f7f7f", size=0.5) +
  geom_point(data = zomato, aes(x = Longitude, y = Latitude),colour = "red4", size = 0.5) +
  coord_map("rectangular", lat0=0, xlim=c(-180,180), ylim=c(-60, 90)) +
  scale_y_continuous(breaks=c()) +
  scale_x_continuous(breaks=c()) +
  labs(fill="legend", title="Restaurant Locations", x="", y="") +
  theme_bw() +
  theme(panel.border = element_blank())
p
```
`r fig_nums("map")`



```{r, warning=FALSE, message=FALSE, echo=FALSE}
cont_rate <- table(zomato$continent,zomato$Rating.text, dnn = c("Continent","Rating"))
prop.cont_rate<-data.frame(prop.table(cont_rate,1))
colnames(prop.cont_rate) <- c("Continent","Rating","Proportion")

p3<-ggplot(prop.cont_rate,aes(x=Continent,y=Proportion,fill=Rating))
p3+geom_bar(stat="identity",position="dodge")+
  labs(title="Proportions of Rating within Continent") +
  theme_minimal()+
  scale_fill_manual(values=c_palette)
```
`r fig_nums("continent-rating")`

\hfill\break



The map provides insight into the locations of the restaurants around the world. Clearly, most of the restaurants in this dataset are based in the USA, India and Australia.

Inspection of `r fig_nums("continent-rating", display = "cite")` highlights that despite being overrepresented in the data, Asian restaurants have relatively low proportions of very good and excellent rated restaurants in comparison to other continents, but have a very high proportion of average restaurants. North America appears to have a relatively high proportion of good-rated restaurants and `Rest of World` has the highest proportion of very good-rated restaurants.

The counts of the different restaurant cuisines were then visualised in `r fig_nums("cuisine", display = "cite")`. `r fig_nums("cuisine-rating", display = "cite")` considers the cuisine type with respect to rating, but here, the continuous aggregate rating variable was used over the discrete version for simplicity and interpretability. 

```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=7}
ggplot(data=zomato,aes(x=cuisine))+
  geom_bar(fill=c_palette[4])+theme_minimal()+
  labs(title="Count of Restaurant Cuisine",
       x="Cuisine",
       y="Count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1))
```
`r fig_nums("cuisine")`

\hfill\break

```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=7}
ggplot(data = zomato, aes(y = Aggregate.rating, x = "")) +
  geom_boxplot(fill = c_palette[4]) + facet_wrap(~cuisine, ncol = 6) +
  theme_minimal() + labs(title = "Aggregate Restaurant Rating by Cuisine",
                         y = "Aggregate Rating",
                         x = "Cuisine")
```
`r fig_nums("cuisine-rating")`

\hfill\break


From `r fig_nums("cuisine", display = "cite")`, it is clear that the restaurants included in this sample mostly belong to either Indian or Asian cuisines. `r fig_nums("cuisine-rating", display = "cite")` highlights that almost all cuisines are centred around an aggregate rating of 3 to 4, which would equate to ratings of good and very good, respectively. Furthermore, most cuisine types appear to have very little variability, however others, such as pizza and Asian cuisines have larger interquartile ranges. This suggests higher variability in the aggregate ratings of these kinds of restaurants.

\newpage

## Multivariate

```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=6.5}
ggplot(data=zomato, aes(x=log(Votes+1), y=Average.Cost.for.two.Std)) +
  geom_point(aes(colour=continent),alpha=.25) +
  facet_wrap(~Rating.text)+
  labs(title="Standardised Average Cost by Log of Votes across Continent",
       x="Log of Votes",
       y="Average Cost for Two (Standardised)")+
  scale_colour_manual(values=c_palette[1:5],name = "Continent")+theme_minimal()+
  guides(colour = guide_legend(override.aes = list(alpha=1)))
```
`r fig_nums("cost-votes-continent")`

\hfill\break

`r fig_nums("cost-votes-continent", display = "cite")` serves to highlight several interesting features within the sample. Foremost, the imbalance of data across the continents as well as rating levels is very clear. The abundance of yellow again suggests that most of the restaurants are from Asia, while the density of points also shows that most of the restaurants received an average or good rating. Furthermore, the dispersion of points in all facets demonstrates that there is no apparent relationship between the cost of a meal and the amount of votes a restaurant receives. It also seems that Asian restaurants are overrepresented in the poor, average and good levels, while there is a more even distribution of the other continents across the other rating levels. On the other hand, for the excellent rating, the proportion of Asian restaurants is relatively low.

```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=6.5}
ggplot(zomato,aes(x=log(Votes+1),fill=Has.Table.booking))+
  geom_density(alpha=0.5)+facet_grid(continent~Rating.text)+
  theme_minimal()+
  labs(title="Distribution of Log of Votes by Table Booking Status\n across Rating and Continent",
       x="Log of Votes",
       y="Density",
       fill = "Table Booking")
```
`r fig_nums("votes-booking-continent")`

\hfill\break

`r fig_nums("votes-booking-continent", display = "cite")` examines how the number of votes a restaurant receives is influenced by its rating, continent and whether table booking is available. There are clearly some issues with data sparsity evidenced by the empty facets. The imbalance of the table booking variable can also be seen with restaurants in Asia being the only ones which consistently have table bookings available for each rating level. Based on this, as well as the other facets which allow for comparison for the two table booking levels, it can be seen that typically the mode of votes is higher for restaurants which offer table booking compared to those which do not, regardless of rating. This assertion should not be generalised outside of Asia however, due to the lack of data.

```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=6.5}
ggplot(zomato,aes(x=continent,y=Average.Cost.for.two.Std))+
  geom_boxplot(aes(fill=Rating.text))+theme_minimal()+
  stat_summary(fun.y = mean, aes(shape="Continent\nMean"), colour = "darkred", geom="point",size=4) +
  scale_shape_manual("", values=c("Continent\nMean"="\u2666"))+
  scale_fill_manual(values=c_palette,name = "Rating")+
  labs(title="Standardised Average Cost for Two \nby Continent and Rating",
       y="Standardised Average Cost",
       x="Continent")
```
`r fig_nums("cost-continent-rating")`

\hfill\break

`r fig_nums("cost-continent-rating", display = "cite")` compares standardised average meal cost by rating and continent. The figure highlights a number of interesting features, including that there is a large amount of variation in cost when both rating and continent are considered. Very good rated restaurants appear to be the only ones which retain similar medians and variation for all continents, except for those in Asia which can be seen to be more variable and expensive. A slight trend can be seen across the continents, with cost increasing with rating type. Oceania sharply contradicts this trend however, with poorly rated restaurants being the most expensive within the continent. Finally, comparison of the mean cost reveals there is almost no difference across the continents.


\newpage

# Summary

\begin{flushleft}Ultimately, this phase was concerned with preparing and exploring the Zomato restaurant data in order to ensure the most accurate and informative modelling in the next phase. Of the original 21 variables, all those which were deemed irrelevant with regards to the upcoming modelling phase were removed. This included variables such as restaurant name, ID, address, etc. Furthermore, it was found that some variables could be further improved and so were either transformed or new variables were created entirely. This included relevelling the cuisine variable, creating the new continent variable based off of country, standardising average meal cost according to currency and log transforming the number of votes each restaurant received. Not all original variables were removed however, as these will still be employed in the modelling phase to assess their relevance in predicting the response variable. Finally, the "Not rated" level of the response variable was dropped, along with all associated observations, as it would not be logical to try and predict this level. This resulted in the response variable having five distinct ordinal levels.\end{flushleft}

\begin{flushleft}The features were then assessed visually to confirm their relevance for modelling. Interesting univariate insights included how average-rated restaurants made up the majority of the data and that most restaurants included in the data were from Asia and had Asian or Indian cuisines. In all bivariate visualisations, some apparent differences were observed across the levels of the response variable with regards to the other variable being assessed. For example, it was shown that Asia had a very large proportion of average-rated restaurants in comparison to other continents, the log of votes increased across ascending rating levels (expect for average-rated restaurants) and that restaurants which offered table booking were more likely be rated good or very good compared to those which did not offer it. The multivariate visualisations served to further explore the interaction between many variables simultaneously, which proved relatively strenuous on the data, with clear evidence of data sparsity. This ultimately suggests that there is not a comprehensive distribution of data across the domains of all variables. Despite this, given that the exploration of the data overarchingly demonstrated clear differences across the response levels based on the other variables, the upcoming modelling phase should prove fruitful.\end{flushleft}

\newpage

# References

---
nocite: | 
  @mlr, @data.table, @dplyr, @plyr, @ggplot2, @vcd, @knitr, @kableExtra,
...


